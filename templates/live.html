<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>å³æ™‚é‡é‡ç›£æ§</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .status-dot {
      display: inline-block;
      width: 0.8em;
      height: 0.8em;
      border-radius: 50%;
      background: gray;
      margin-right: 0.5em;
    }

    .status-connected {
      background: #28a745;
    }

    .status-disconnected {
      background: #dc3545;
    }
  </style>
</head>

<body>
  <div class="container mt-4">
    <h2>âš–ï¸ å³æ™‚é‡é‡ç›£æ§</h2>

    <!-- WebSocket é€£ç·šç‹€æ…‹ -->
    <div class="my-3">
      <span id="statusDot" class="status-dot"></span>
      <span id="statusText">å°šæœªé€£ç·š</span>
    </div>
    <!-- ESP32 é€£ç·šç‹€æ…‹ -->
    <div class="my-1">
      <span id="espDot" class="status-dot"></span>
      <span id="espText">ESP32 æœªé€£ç·š</span>
    </div>

    <!-- é‡ç½®æŒ‰éˆ• -->
    <div class="my-3">
      <button id="resetBtn" class="btn btn-warning" onclick="resetESP()">ğŸ”„ é‡ç½®æ•¸æ“š</button>
    </div>

    <!-- è³‡æ–™é¡¯ç¤ºå€ -->
    <!-- ç¸½é‡é‡ -->
    <div class="row text-center mb-3">
      <div class="col-12">
        <div class="card p-3">
          <h5>ç¸½é‡é‡ (g)</h5>
          <p id="totalWeight" class="display-6">--</p>
        </div>
      </div>
    </div>

    <!-- å…¶ä»–é …ç›® -->
    <div class="row text-center">
      <div class="col">
        <div class="card p-3">
          <h5>å°èºæ¯æ•¸é‡</h5>
          <p id="countSmall" class="display-6">--</p>
        </div>
      </div>
      <div class="col">
        <div class="card p-3">
          <h5>å¤§èºæ¯æ•¸é‡</h5>
          <p id="countLarge" class="display-6">--</p>
        </div>
      </div>
      <div class="col">
        <div class="card p-3">
          <h5>éµç®¡æ•¸é‡</h5>
          <p id="countTube" class="display-6">--</p>
        </div>
      </div>
      <div class="col">
        <div class="card p-3">
          <h5>ç«‹å¸ƒç®¡æ•¸é‡</h5>
          <p id="countNip" class="display-6">--</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const protocol = location.hostname === "127.0.0.1" ? "ws" : "wss";
    const WS_CLIENT_URL = `${protocol}://${location.host}/ws/client`;
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const elTotal = document.getElementById("totalWeight");
    const elSmall = document.getElementById("countSmall");
    const elLarge = document.getElementById("countLarge");
    const elTube = document.getElementById("countTube");
    const elNip = document.getElementById("countNip");

    // é‡ç½® ESP32 å‡½æ•¸
    async function resetESP() {
      const resetBtn = document.getElementById("resetBtn");
      try {
        resetBtn.disabled = true;
        resetBtn.textContent = "é‡ç½®ä¸­...";
        
        const response = await fetch('/esp/reset', {
          method: 'POST'
        });
        
        if (response.ok) {
          resetBtn.textContent = "é‡ç½®æˆåŠŸ";
          resetBtn.className = "btn btn-success";
          setTimeout(() => {
            resetBtn.disabled = false;
            resetBtn.textContent = "ğŸ”„ é‡ç½®æ•¸æ“š";
            resetBtn.className = "btn btn-warning";
          }, 2000);
        } else {
          throw new Error('é‡ç½®å¤±æ•—');
        }
      } catch (error) {
        console.error('é‡ç½®éŒ¯èª¤:', error);
        resetBtn.textContent = "é‡ç½®å¤±æ•—";
        resetBtn.className = "btn btn-danger";
        setTimeout(() => {
          resetBtn.disabled = false;
          resetBtn.textContent = "ğŸ”„ é‡ç½®æ•¸æ“š";
          resetBtn.className = "btn btn-warning";
        }, 2000);
      }
    }

    let ws;
    function connect() {
      ws = new WebSocket(WS_CLIENT_URL);

      ws.onopen = () => {
        statusDot.className = "status-dot status-connected";
        statusText.textContent = "å·²é€£ç·šåˆ° Server";
      };
      ws.onmessage = evt => {
        const msg = JSON.parse(evt.data);
        if (msg.type === 'status') {
          // ESP32 ç‹€æ…‹æ›´æ–°
          if (msg.esp) {
            espDot.className = "status-dot status-connected";
            espText.textContent = "ESP32 å·²é€£ç·š";
          } else {
            espDot.className = "status-dot status-disconnected";
            espText.textContent = "ESP32 å·²æ–·ç·š";
          }
        } else {
          // å¯¦éš›è³‡æ–™æ›´æ–°
          elTotal.textContent = msg.weight;
          elSmall.textContent = msg.small;
          elLarge.textContent = msg.big;
          elTube.textContent = msg.tube;
          // elNip.textContent = msg.?
        }
      };
      ws.onclose = () => {
        statusDot.className = "status-dot status-disconnected";
        statusText.textContent = "å·²æ–·ç·šï¼Œ5ç§’å¾Œé‡é€£â€¦";
        setTimeout(connect, 5000);
      };
      ws.onerror = e => console.error("WS éŒ¯èª¤ï¼š", e);
    }

    connect();
  </script>
</body>

</html>