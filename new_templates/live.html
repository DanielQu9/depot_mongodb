<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>即時重量監控</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: #2c3e50;
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .page-header {
      text-align: center;
      margin-bottom: 3rem;
    }

    .page-title {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #2c3e50, #34495e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }

    .page-subtitle {
      font-size: 1.1rem;
      color: #6c757d;
      font-weight: 300;
    }

    .status-section {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .status-section:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .status-row:last-child {
      margin-bottom: 0;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 600;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #6c757d;
      animation: pulse 2s infinite;
      flex-shrink: 0;
    }

    .status-connected {
      background: linear-gradient(135deg, #48dbfb, #0abde3);
      box-shadow: 0 0 10px rgba(72, 219, 251, 0.5);
    }

    .status-disconnected {
      background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
      box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .reset-btn {
      background: linear-gradient(135deg, #feca57, #ff9ff3);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(254, 202, 87, 0.4);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .reset-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(254, 202, 87, 0.6);
      color: white;
    }

    .reset-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .weight-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }

    .data-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .data-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      z-index: 1;
    }

    .data-card > * {
      position: relative;
      z-index: 2;
    }

    .data-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    }

    .data-card.primary {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border: 2px solid rgba(102, 126, 234, 0.2);
    }

    .data-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .data-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #495057;
      margin-bottom: 1rem;
    }

    .data-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: #2c3e50;
      margin-bottom: 0.5rem;
      transition: all 0.3s ease;
    }

    .data-value.updating {
      color: #667eea;
      animation: dataUpdate 0.5s ease-in-out;
    }

    @keyframes dataUpdate {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .data-unit {
      font-size: 0.9rem;
      color: #6c757d;
      font-weight: 500;
    }

    .total-weight .data-value {
      font-size: 3.5rem;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .connection-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      padding: 0.75rem 1rem;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    /* 動畫效果 */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .page-header {
      animation: fadeInUp 0.8s ease-out;
    }

    .status-section {
      animation: fadeInUp 0.8s ease-out 0.2s both;
    }

    .weight-grid {
      animation: fadeInUp 0.8s ease-out 0.4s both;
    }

    .data-grid {
      animation: fadeInUp 0.8s ease-out 0.6s both;
    }

    .data-card {
      animation: fadeInUp 0.6s ease-out both;
    }

    .data-card:nth-child(1) { animation-delay: 0.1s; }
    .data-card:nth-child(2) { animation-delay: 0.2s; }
    .data-card:nth-child(3) { animation-delay: 0.3s; }

    /* 響應式設計 */
    @media (max-width: 768px) {
      .page-title {
        font-size: 2rem;
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .status-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      
      .data-grid {
        grid-template-columns: 1fr;
      }
      
      .data-card {
        padding: 1.5rem;
      }
      
      .total-weight .data-value {
        font-size: 2.5rem;
      }
      
      .data-value {
        font-size: 2rem;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 1rem;
      }
      
      .data-card {
        padding: 1rem;
      }
      
      .connection-indicator {
        position: relative;
        top: auto;
        right: auto;
        margin-bottom: 1rem;
        text-align: center;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- 頁面標題 -->
    <div class="page-header">
      <h1 class="page-title">
        <i class="fas fa-weight"></i>
        即時重量監控
      </h1>
      <p class="page-subtitle">ESP32 感測器即時數據監控系統</p>
    </div>

    <!-- 連線狀態區塊 -->
    <div class="status-section">
      <div class="status-row">
        <div class="status-item">
          <span id="statusDot" class="status-dot"></span>
          <span id="statusText">尚未連線到伺服器</span>
        </div>
        <div class="status-item">
          <span id="espDot" class="status-dot"></span>
          <span id="espText">ESP32 未連線</span>
        </div>
        <button id="resetBtn" class="reset-btn" onclick="resetESP()">
          <i class="fas fa-redo"></i>
          重置數據
        </button>
      </div>
    </div>

    <!-- 總重量顯示 -->
    <div class="weight-grid">
      <div class="data-card primary total-weight">
        <div class="data-icon">
          <i class="fas fa-balance-scale"></i>
        </div>
        <h3 class="data-title">總重量</h3>
        <div id="totalWeight" class="data-value">--</div>
        <div class="data-unit">公克 (g)</div>
      </div>
    </div>

    <!-- 其他數據 -->
    <div class="data-grid">
      <div class="data-card">
        <div class="data-icon">
          <i class="fas fa-circle"></i>
        </div>
        <h3 class="data-title">小螺母數量</h3>
        <div id="countSmall" class="data-value">--</div>
        <div class="data-unit">個</div>
      </div>
      
      <div class="data-card">
        <div class="data-icon">
          <i class="fas fa-dot-circle"></i>
        </div>
        <h3 class="data-title">大螺母數量</h3>
        <div id="countLarge" class="data-value">--</div>
        <div class="data-unit">個</div>
      </div>
      
      <div class="data-card">
        <div class="data-icon">
          <i class="fas fa-pipe"></i>
        </div>
        <h3 class="data-title">鐵管數量</h3>
        <div id="countTube" class="data-value">--</div>
        <div class="data-unit">根</div>
      </div>
      </div>
        <h3 class="data-title">立布管數量</h3>
        <div id="countLibu" class="data-value">--</div>
        <div class="data-unit">根</div>
      </div>
    </div>
  </div>

  <!-- 連線指示器 -->
  <div id="connectionIndicator" class="connection-indicator">
    <i class="fas fa-wifi"></i>
    <span>檢查連線中...</span>
  </div>

  <script>
    const protocol = location.hostname === "127.0.0.1" ? "ws" : "wss";
    const WS_CLIENT_URL = `${protocol}://${location.host}/ws/client`;
    
    // DOM 元素
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const espDot = document.getElementById("espDot");
    const espText = document.getElementById("espText");
    const elTotal = document.getElementById("totalWeight");
    const elSmall = document.getElementById("countSmall");
    const elLarge = document.getElementById("countLarge");
    const elTube = document.getElementById("countTube");
    const elLibu = document.getElementById("countLibu");
    const connectionIndicator = document.getElementById("connectionIndicator");

    // 重置 ESP32 函數
    async function resetESP() {
      const resetBtn = document.getElementById("resetBtn");
      const originalHTML = resetBtn.innerHTML;
      
      try {
        resetBtn.disabled = true;
        resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 重置中...';
        resetBtn.style.background = '#6c757d';
        
        const response = await fetch('/esp/reset', {
          method: 'POST'
        });
        
        if (response.ok) {
          resetBtn.innerHTML = '<i class="fas fa-check"></i> 重置成功';
          resetBtn.style.background = 'linear-gradient(135deg, #48dbfb, #0abde3)';
          
          // 顯示成功通知
          showNotification('ESP32 數據重置成功', 'success');
          
          setTimeout(() => {
            resetBtn.disabled = false;
            resetBtn.innerHTML = originalHTML;
            resetBtn.style.background = '';
          }, 2000);
        } else {
          throw new Error('重置失敗');
        }
      } catch (error) {
        console.error('重置錯誤:', error);
        resetBtn.innerHTML = '<i class="fas fa-times"></i> 重置失敗';
        resetBtn.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a6f)';
        
        showNotification('ESP32 數據重置失敗', 'error');
        
        setTimeout(() => {
          resetBtn.disabled = false;
          resetBtn.innerHTML = originalHTML;
          resetBtn.style.background = '';
        }, 2000);
      }
    }

    // WebSocket 連線
    let ws;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    function connect() {
      try {
        ws = new WebSocket(WS_CLIENT_URL);

        ws.onopen = () => {
          console.log('WebSocket 連線成功');
          statusDot.className = "status-dot status-connected";
          statusText.textContent = "已連線到伺服器";
          connectionIndicator.innerHTML = '<i class="fas fa-wifi"></i> <span>已連線</span>';
          connectionIndicator.style.color = '#28a745';
          reconnectAttempts = 0;
        };

        ws.onmessage = evt => {
          try {
            const msg = JSON.parse(evt.data);
            
            if (msg.type === 'status') {
              // ESP32 狀態更新
              if (msg.esp) {
                espDot.className = "status-dot status-connected";
                espText.textContent = "ESP32 已連線";
              } else {
                espDot.className = "status-dot status-disconnected";
                espText.textContent = "ESP32 已斷線";
              }
            } else {
              // 實際資料更新
              updateDataWithAnimation(elTotal, msg.weight);
              updateDataWithAnimation(elSmall, msg.small);
              updateDataWithAnimation(elLarge, msg.big);
              updateDataWithAnimation(elTube, msg.tube);
              updateDataWithAnimation(elLibu, msg.libu);
            }
          } catch (error) {
            console.error('解析訊息錯誤:', error);
          }
        };

        ws.onclose = () => {
          console.log('WebSocket 連線關閉');
          statusDot.className = "status-dot status-disconnected";
          statusText.textContent = "連線已斷開";
          connectionIndicator.innerHTML = '<i class="fas fa-wifi"></i> <span>重新連線中...</span>';
          connectionIndicator.style.color = '#dc3545';
          
          if (reconnectAttempts < maxReconnectAttempts) {
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
            reconnectAttempts++;
            setTimeout(connect, delay);
          } else {
            connectionIndicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>連線失敗</span>';
            showNotification('無法連接到伺服器，請檢查網路連線', 'error');
          }
        };

        ws.onerror = e => {
          console.error("WebSocket 錯誤：", e);
          connectionIndicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>連線錯誤</span>';
          connectionIndicator.style.color = '#dc3545';
        };

      } catch (error) {
        console.error('建立 WebSocket 連線錯誤:', error);
      }
    }

    // 數據更新動畫
    function updateDataWithAnimation(element, value) {
      element.classList.add('updating');
      element.textContent = value;
      setTimeout(() => {
        element.classList.remove('updating');
      }, 500);
    }

    // 通知系統
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1001;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        transform: translateX(100%);
        transition: all 0.3s ease;
        max-width: 300px;
      `;

      switch (type) {
        case 'success':
          notification.style.background = 'linear-gradient(135deg, #48dbfb, #0abde3)';
          break;
        case 'error':
          notification.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a6f)';
          break;
        default:
          notification.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
      }

      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => notification.style.transform = 'translateX(0)', 100);
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => document.body.removeChild(notification), 300);
      }, 3000);
    }

    // 初始化連線
    connect();

    // 頁面可見性變化處理
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && (!ws || ws.readyState === WebSocket.CLOSED)) {
        connect();
      }
    });
  </script>
</body>

</html>